name: Deploy to App Engine

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering from GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "::error::GCP_SA_KEY secret is not set. Please configure GitHub secrets."
            echo "See SETUP_GITHUB_ACTIONS.md for instructions."
            exit 1
          fi
          echo "✓ Required secrets are configured"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          NEXT_PUBLIC_MAPBOX_TOKEN: ${{ secrets.MAPBOX_TOKEN }}

      - name: Prepare standalone build for deployment
        run: |
          # Copy standalone build to root (App Engine expects files at root)
          cp -r .next/standalone/* .
          # Copy static assets - Next.js standalone expects .next/static relative to server.js
          mkdir -p .next
          cp -r .next/static .next/static || true
          # Ensure app.yaml is in the deployment root
          cp app.yaml . || true
          # List files to verify deployment structure
          echo "Files ready for deployment:"
          ls -la | head -20
          echo "Checking for required files:"
          test -f server.js && echo "✓ server.js found" || echo "✗ server.js missing"
          test -f package.json && echo "✓ package.json found" || echo "✗ package.json missing"
          test -f app.yaml && echo "✓ app.yaml found" || echo "✗ app.yaml missing"
          test -d .next/static && echo "✓ .next/static directory found" || echo "✗ .next/static directory missing"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set GCP Project
        run: gcloud config set project nexus-nosh

      - name: Deploy to App Engine
        run: gcloud app deploy --verbosity=debug 2>&1 | tee deploy.log || (cat deploy.log && exit 1)
        env:
          CLOUDSDK_CORE_PROJECT: nexus-nosh

      - name: Migrate traffic to new version
        run: |
          # Wait a moment for the version to be fully created
          sleep 5
          # Get the latest deployed version (most recently created)
          NEW_VERSION=$(gcloud app versions list --format="value(id)" --sort-by=~creationTime --limit=1 --service=default)
          echo "Latest version found: $NEW_VERSION"
          echo "Migrating 100% traffic to version: $NEW_VERSION"
          gcloud app services set-traffic default --splits=$NEW_VERSION=1 --quiet
          echo "✓ Traffic migration complete"
          # Verify traffic split
          CURRENT_TRAFFIC=$(gcloud app services describe default --format="value(split.allocations)" --quiet)
          echo "Current traffic allocation: $CURRENT_TRAFFIC"
        env:
          CLOUDSDK_CORE_PROJECT: nexus-nosh

