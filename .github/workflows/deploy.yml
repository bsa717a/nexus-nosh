name: Deploy to App Engine

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering from GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "::error::GCP_SA_KEY secret is not set. Please configure GitHub secrets."
            echo "See SETUP_GITHUB_ACTIONS.md for instructions."
            exit 1
          fi
          echo "✓ Required secrets are configured"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          NEXT_PUBLIC_MAPBOX_TOKEN: ${{ secrets.MAPBOX_TOKEN }}

      - name: Prepare standalone build for deployment
        run: |
          # Verify standalone build exists
          if [ ! -d ".next/standalone" ]; then
            echo "::error::Standalone build not found. Build may have failed."
            exit 1
          fi
          # Copy standalone build to root (App Engine expects files at root)
          echo "Copying standalone build files..."
          cp -r .next/standalone/* .
          # Copy static assets - Next.js standalone expects .next/static relative to server.js
          if [ -d ".next/static" ]; then
            mkdir -p .next
            cp -r .next/static .next/static
            echo "✓ Static assets copied"
          else
            echo "⚠️  .next/static not found (may be in standalone directory)"
          fi
          # Verify required files exist
          echo "Verifying deployment files:"
          test -f server.js && echo "✓ server.js found" || (echo "✗ server.js missing" && exit 1)
          test -f package.json && echo "✓ package.json found" || (echo "✗ package.json missing" && exit 1)
          test -f app.yaml && echo "✓ app.yaml found" || (echo "✗ app.yaml missing" && exit 1)
          echo "✓ All required files present"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set GCP Project
        run: gcloud config set project nexus-nosh

      - name: Deploy to App Engine
        id: deploy
        run: |
          echo "Starting deployment..."
          DEPLOY_OUTPUT=$(gcloud app deploy --quiet 2>&1 | tee deploy.log)
          DEPLOY_EXIT=$?
          cat deploy.log
          if [ $DEPLOY_EXIT -ne 0 ]; then
            echo "::error::Deployment failed with exit code $DEPLOY_EXIT"
            exit $DEPLOY_EXIT
          fi
          # Extract version ID from deployment output
          VERSION_ID=$(grep -oP 'target version: \[\K[^\]]+' deploy.log | head -1 || echo "")
          if [ -z "$VERSION_ID" ]; then
            echo "Version ID not found in output, waiting and checking latest version..."
            sleep 5
            VERSION_ID=$(gcloud app versions list --format="value(id)" --sort-by=~creationTime --limit=1 --service=default)
          fi
          if [ -z "$VERSION_ID" ]; then
            echo "::error::Could not determine deployed version ID"
            exit 1
          fi
          echo "✓ Successfully deployed version: $VERSION_ID"
          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDSDK_CORE_PROJECT: nexus-nosh

      - name: Migrate traffic to new version
        run: |
          NEW_VERSION="${{ steps.deploy.outputs.version_id }}"
          if [ -z "$NEW_VERSION" ]; then
            echo "Could not determine version ID, using latest"
            NEW_VERSION=$(gcloud app versions list --format="value(id)" --sort-by=~creationTime --limit=1 --service=default)
          fi
          echo "Migrating 100% traffic to version: $NEW_VERSION"
          gcloud app services set-traffic default --splits=$NEW_VERSION=1 --quiet
          echo "✓ Traffic migration complete"
          # Verify traffic split
          CURRENT_TRAFFIC=$(gcloud app services describe default --format="value(split.allocations)" --quiet)
          echo "Current traffic allocation: $CURRENT_TRAFFIC"
        env:
          CLOUDSDK_CORE_PROJECT: nexus-nosh

