name: Deploy to App Engine

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering from GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "::error::GCP_SA_KEY secret is not set. Please configure GitHub secrets."
            echo "See SETUP_GITHUB_ACTIONS.md for instructions."
            exit 1
          fi
          echo "✓ Required secrets are configured"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          NEXT_PUBLIC_MAPBOX_TOKEN: ${{ secrets.MAPBOX_TOKEN }}

      - name: Prepare deployment directory
        run: |
          echo "Preparing clean deployment directory..."
          mkdir deploy
          
          # Copy standalone build to deploy dir
          cp -r .next/standalone/* deploy/
          
          # Copy static assets (required for Next.js)
          mkdir -p deploy/.next/static
          cp -r .next/static/* deploy/.next/static/
          
          # Copy public folder
          cp -r public deploy/
          
          # Copy app.yaml
          cp app.yaml deploy/
          
          # Setup .gcloudignore in deploy dir to ignore nothing (we only put what we want in there)
          # We might want to verify node_modules size
          echo "Checking standalone node_modules size:"
          du -sh deploy/node_modules
          find deploy/node_modules -type f | wc -l || echo "Cannot count files"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set GCP Project
        run: gcloud config set project nexus-nosh

      - name: Inject Environment Variables
        run: |
          # Replace GEMINI_API_KEY_PLACEHOLDER with actual secret
          # Perform replacement in the deploy/app.yaml
          if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            sed -i "s|GEMINI_API_KEY_PLACEHOLDER|${{ secrets.GEMINI_API_KEY }}|g" deploy/app.yaml
          else
            echo "::warning::GEMINI_API_KEY secret not found, leaving placeholder"
          fi

      - name: Deploy to App Engine
        id: deploy
        run: |
          echo "Starting deployment..."
          cd deploy
          
          # Deploy and capture output
          gcloud app deploy --quiet --promote 2>&1 | tee ../deploy.log
          DEPLOY_EXIT=${PIPESTATUS[0]}
          
          if [ $DEPLOY_EXIT -ne 0 ]; then
            echo "::error::Deployment failed with exit code $DEPLOY_EXIT"
            cat ../deploy.log
            exit $DEPLOY_EXIT
          fi
          
          # Wait and get version as before...
          cd ..
          
          # Get the latest deployed version
          VERSION_ID=$(gcloud app versions list --format="value(id)" --sort-by=~version.createTime --limit=1 --service=default)
          
          if [ -z "$VERSION_ID" ]; then
            echo "::error::Could not determine deployed version ID"
            exit 1
          fi
          
          echo "✓ Successfully deployed version: $VERSION_ID"
          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDSDK_CORE_PROJECT: nexus-nosh

      - name: Verify and migrate traffic
        run: |
          NEW_VERSION="${{ steps.deploy.outputs.version_id }}"
          
          if [ -z "$NEW_VERSION" ]; then
            echo "Version ID not passed from deploy step, fetching latest..."
            NEW_VERSION=$(gcloud app versions list --format="value(id)" --sort-by=~version.createTime --limit=1 --service=default)
          fi
          
          if [ -z "$NEW_VERSION" ]; then
            echo "::error::Could not determine version to migrate traffic to"
            exit 1
          fi
          
          echo "Target version: $NEW_VERSION"
          
          # Check current traffic allocation
          CURRENT_VERSION=$(gcloud app services describe default --format="value(split.allocations)" | head -1 | cut -d: -f1)
          echo "Current traffic version: $CURRENT_VERSION"
          
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "✓ Traffic already on correct version: $NEW_VERSION"
          else
            echo "Migrating traffic from $CURRENT_VERSION to $NEW_VERSION..."
            gcloud app services set-traffic default --splits="$NEW_VERSION=1" --quiet --migrate
            echo "✓ Traffic migration complete"
          fi
          
          # Verify final traffic allocation
          echo "Verifying traffic allocation..."
          FINAL_TRAFFIC=$(gcloud app services describe default --format="yaml(split)")
          echo "$FINAL_TRAFFIC"
          
          # Double-check the traffic is on the new version
          FINAL_VERSION=$(echo "$FINAL_TRAFFIC" | grep -o '[0-9]\{8\}t[0-9]\{6\}' | head -1)
          if [ "$FINAL_VERSION" = "$NEW_VERSION" ]; then
            echo "✓ Confirmed: 100% traffic on version $NEW_VERSION"
          else
            echo "::warning::Traffic may not be fully migrated. Expected $NEW_VERSION, got $FINAL_VERSION"
          fi
        env:
          CLOUDSDK_CORE_PROJECT: nexus-nosh

