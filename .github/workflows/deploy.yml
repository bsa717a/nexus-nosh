name: Deploy to App Engine

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering from GitHub Actions UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "::error::GCP_SA_KEY secret is not set. Please configure GitHub secrets."
            echo "See SETUP_GITHUB_ACTIONS.md for instructions."
            exit 1
          fi
          echo "✓ Required secrets are configured"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          NEXT_PUBLIC_MAPBOX_TOKEN: ${{ secrets.MAPBOX_TOKEN }}

      - name: Prepare standalone build for deployment
        run: |
          # Verify standalone build exists
          if [ ! -d ".next/standalone" ]; then
            echo "::error::Standalone build not found. Build may have failed."
            exit 1
          fi
          # Copy standalone build to root (App Engine expects files at root)
          echo "Copying standalone build files..."
          # Save reference to original static directory before copying
          ORIGINAL_STATIC=".next/static"
          cp -r .next/standalone/* .
          # Copy static assets - Next.js standalone expects .next/static relative to server.js
          # Check if static was already copied from standalone, if not copy from original location
          if [ ! -d ".next/static" ]; then
            if [ -d "$ORIGINAL_STATIC" ]; then
              echo "Copying static assets from build directory..."
              mkdir -p .next
              cp -r "$ORIGINAL_STATIC" .next/static
              echo "✓ Static assets copied"
            else
              echo "⚠️  .next/static not found"
            fi
          else
            echo "✓ Static assets already present (copied from standalone)"
          fi
          # Verify required files exist
          echo "Verifying deployment files:"
          test -f server.js && echo "✓ server.js found" || (echo "✗ server.js missing" && exit 1)
          test -f package.json && echo "✓ package.json found" || (echo "✗ package.json missing" && exit 1)
          test -f app.yaml && echo "✓ app.yaml found" || (echo "✗ app.yaml missing" && exit 1)
          echo "✓ All required files present"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set GCP Project
        run: gcloud config set project nexus-nosh

      - name: Configure .gcloudignore for deployment
        run: |
          echo "Creating custom .gcloudignore for standalone deployment..."
          # Start with ignoring everything
          echo "*" > .gcloudignore
          # Whitelist the necessary files for standalone runtime
          echo "!server.js" >> .gcloudignore
          echo "!package.json" >> .gcloudignore
          echo "!app.yaml" >> .gcloudignore
          echo "!public/" >> .gcloudignore
          echo "!.next/static/" >> .gcloudignore
          echo "!node_modules/" >> .gcloudignore
          
          echo "Generated .gcloudignore content:"
          cat .gcloudignore

      - name: Inject Environment Variables
        run: |
          # Replace GEMINI_API_KEY_PLACEHOLDER with actual secret
          # Use a different delimiter (|) in case the key contains slashes
          if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            sed -i "s|GEMINI_API_KEY_PLACEHOLDER|${{ secrets.GEMINI_API_KEY }}|g" app.yaml
          else
            echo "::warning::GEMINI_API_KEY secret not found, leaving placeholder"
          fi

      - name: Deploy to App Engine
        id: deploy
        run: |
          echo "Starting deployment..."
          # Deploy and capture output
          gcloud app deploy --quiet --promote 2>&1 | tee deploy.log
          DEPLOY_EXIT=${PIPESTATUS[0]}
          
          if [ $DEPLOY_EXIT -ne 0 ]; then
            echo "::error::Deployment failed with exit code $DEPLOY_EXIT"
            cat deploy.log
            exit $DEPLOY_EXIT
          fi
          
          # Wait for deployment to fully propagate
          echo "Waiting for deployment to propagate..."
          sleep 10
          
          # Get the latest deployed version
          VERSION_ID=$(gcloud app versions list --format="value(id)" --sort-by=~version.createTime --limit=1 --service=default)
          
          if [ -z "$VERSION_ID" ]; then
            echo "::error::Could not determine deployed version ID"
            exit 1
          fi
          
          echo "✓ Successfully deployed version: $VERSION_ID"
          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDSDK_CORE_PROJECT: nexus-nosh

      - name: Verify and migrate traffic
        run: |
          NEW_VERSION="${{ steps.deploy.outputs.version_id }}"
          
          if [ -z "$NEW_VERSION" ]; then
            echo "Version ID not passed from deploy step, fetching latest..."
            NEW_VERSION=$(gcloud app versions list --format="value(id)" --sort-by=~version.createTime --limit=1 --service=default)
          fi
          
          if [ -z "$NEW_VERSION" ]; then
            echo "::error::Could not determine version to migrate traffic to"
            exit 1
          fi
          
          echo "Target version: $NEW_VERSION"
          
          # Check current traffic allocation
          CURRENT_VERSION=$(gcloud app services describe default --format="value(split.allocations)" | head -1 | cut -d: -f1)
          echo "Current traffic version: $CURRENT_VERSION"
          
          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "✓ Traffic already on correct version: $NEW_VERSION"
          else
            echo "Migrating traffic from $CURRENT_VERSION to $NEW_VERSION..."
            gcloud app services set-traffic default --splits="$NEW_VERSION=1" --quiet --migrate
            echo "✓ Traffic migration complete"
          fi
          
          # Verify final traffic allocation
          echo "Verifying traffic allocation..."
          FINAL_TRAFFIC=$(gcloud app services describe default --format="yaml(split)")
          echo "$FINAL_TRAFFIC"
          
          # Double-check the traffic is on the new version
          FINAL_VERSION=$(echo "$FINAL_TRAFFIC" | grep -o '[0-9]\{8\}t[0-9]\{6\}' | head -1)
          if [ "$FINAL_VERSION" = "$NEW_VERSION" ]; then
            echo "✓ Confirmed: 100% traffic on version $NEW_VERSION"
          else
            echo "::warning::Traffic may not be fully migrated. Expected $NEW_VERSION, got $FINAL_VERSION"
          fi
        env:
          CLOUDSDK_CORE_PROJECT: nexus-nosh

